---
title: "Of mice and men"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo    = TRUE,
                      message = FALSE)
```


Looking at data from
Zhang *et al.*
Short-course chemotherapy with TMC207 and rifapentine in a murine model of
latent tuberculosis infection.
*American Journal of Respiratory and Critical Care Medicine* 184.6 (2011): 732-737.
[10.1164/rccm.201103-0397OC](https://doi.org/10.1164/rccm.201103-0397oc)

## Packages

```{r}
library(readxl)
library(dplyr)
library(purrr)
library(tidyr)
```


## Utilitary functions

A function that adds proportions estimate and confidence interval to a data
frame from a column of successes and a column or trials:

```{r}
add_prop_est <- function(df, x, n, p = "est", l = "lwr", u = "upr", ...) {
  df |> 
    mutate(test   = map2({{ x }}, {{ n }}, prop.test, ...),
           "{p}" := map_dbl(test, ~ .x[["estimate"]]),
           conf   = map(test, ~ setNames(.x[["conf.int"]], c(l, u)))) |> 
    unnest_wider(conf) |> 
    select(- test)
}
```


## The data

```{r}
table2 <- read_excel("table 2 Zhang et al 2011.xlsx")
```

The data look like this:

```{r}
table2
```


## Analysis

```{r}
table2a <- table2 |>
  add_prop_est(positive, total) |> 
  mutate_at("duration", jitter, factor = .2)
```

```{r}
add_data <- function(x, col) {
  table2a |> 
    filter(group == x) |> 
    with({
      points(duration, est, col = col)
      arrows(duration, lwr, duration, upr, .1, 90, 3, col)
    })
}
```

```{r}
treatments <- unique(table2$group)

t0_val <- 1e4

table2b <- bind_rows(
  table2,
  tibble(group = treatments, duration = 0, positive = t0_val, total = t0_val))
```

```{r}
add_model <- function(x, col) {
  dt <- filter(table2b, group == x)
  df <- sum(dt$total)
  
  model <- glm(cbind(total - positive, total) ~ duration, binomial, dt)
  linkinv <- model$family$linkinv
  
  predictions <- tibble(duration = seq(0, 6, le = 512))
  
  preds <- predict(model, predictions, se.fit = TRUE)
  se_fit <- preds$se.fit
  
  predictions |> 
    mutate(fit = preds$fit,
           lwr = 1 - linkinv(fit + qt(.975, df) * se_fit),
           upr = 1 - linkinv(fit + qt(.025, df) * se_fit),
           fit = 1 - linkinv(fit)) |> 
    with({
      polygon(c(duration, rev(duration)), c(lwr, rev(upr)), border = NA, col = adjustcolor(col, .2))
      lines(duration, fit, col = col)
    })
}
```

```{r}
plot(NA, xlim = c(0, 6), ylim = 0:1,
     xlab = "duration of treatment (months)",
     ylab = "proportion positive")

walk2(treatments, 1:4, add_data)
walk2(treatments, 1:4, add_model)
#walk2(treatments[c(2, 3)], c(2, 3), add_model)
```

