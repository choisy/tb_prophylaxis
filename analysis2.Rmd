---
title: "Model v2.0"
output:
  html_document:
    toc: yes
    toc_float: no
    toc_depth: 4
editor_options: 
  chunk_output_type: console
---


```{r setup, include = FALSE}
knitr::knit_hooks$set(
  margin1 = function(before, options, envir) {
    if (before) par(mgp = c(1.5, .5, 0), bty = "n", plt = c(.105, .97, .13, .97))
    else NULL
  },
  margin2 = function(before, options, envir) {
    if (before) par(mgp = c(1.5, .5, 0), bty = "n", plt = c(.2, .97, .2, .85))
    else NULL
  })

knitr::opts_chunk$set(margin1    = TRUE,
                      echo       = TRUE,
                      cache      = FALSE,
                      autodep    = TRUE,
                      message    = FALSE,
                      warning    = FALSE,
                      dev.args   = list(pointsize = 11),
                      fig.height = 3.5,
                      fig.width  = 4.24725,
                      fig.retina = 2,
                      fig.align  = "center")
```


## Packages

Required: `deSolve`, `tibble`

```{r}
library(tibble)
```


## Functions

```{r}
ode2 <- function(...) as_tibble(as.data.frame(deSolve::ode(...)))
```

```{r}
seq2 <- function(...) seq(..., le = 512)
```

```{r}
plot2 <- function(..., col = 4) plot(..., type = "l", lwd = 2, col = col)
```

```{r}
plot3 <- function(x, y, ...) {
  plot2(x, y, xlab = "time (years)", ylim = c(0, max(y)),
        cex.lab = 1.5, cex.axis = 1.5, ...)
}
```


## Epidemiological model


**Variables:**

* $S$: non-infected
* $I_1$: recently infected
* $I_2$: infected a long time ago
* $I_3$: treated but not sterilized
* $D$: sick and infectious
* $N = S + I_1 + I_2 + I_3 + D$


**Parameters:**

* $\beta$: infectious contact rate (/ind/year)
* $\sigma_1$ and $\sigma_2$: clearance rates (/year) of $I_1$ and $I_2$
respectively, either through natural immunity or prophylactic treatment
* $\delta_1$, $\delta_2$ and $\delta_3$: progression rates (/year) of infection
to disease for $I_1$, $I_2$ and $I_3$ (relapse) respectively
* $\gamma$: rate (/year) of recovery with clearance either from treatment or
natural immunity
* $\rho$: rate (/year) of recovery without clearance (ultimately leading to
relapse)
* $\tau$: rate (/year) at which infected transit from a status of recent
infection to a status of non-recent infection

**Note:** all these rates are *per capita*


**Flow diagram:**

<div style="text-align:center"><img src ="SI1I2I3Dmu.png" width="360"/></div>


**Differential equations:**

$$
\begin{align} 
  \frac{dS}{dt}   &= b N + \sigma_1 I_1 + \sigma_2 I_2 + \gamma D - \left(\mu + \beta \frac{D}{N} \right) S \\
  \frac{dI_1}{dt} &= \beta \frac{D}{N} S - (\mu + \sigma_1 + \delta_1 + \tau) I_1       \\
  \frac{dI_2}{dt} &= \tau I_1 - (\mu + \delta_2 + \sigma_2) I_2                         \\
  \frac{dI_3}{dt} &= \rho D - (\mu + \delta_3) I_3                                        \\
  \frac{dD}{dt}   &= \delta_1 I_1 + \delta_2 I_2 + \delta_3 I_3 - (\mu + \alpha + \gamma + \rho) D
\end{align}
$$


**Endemic equilibrium:**

$$
\begin{align}
  S   &= \frac{(\delta_2 + \sigma_2) (\delta_1 + \sigma_1 + \tau)}
              {(\delta_2 + \sigma_2) \delta_1 + \tau \delta_2}
         \frac{\gamma}{\beta} N                                    \\
  I_2 &= \frac{N - S}{1 + (\delta_2 + \sigma_2) / \tau + (1 + \rho / \delta_3)((\delta_2 + \sigma_2) \delta_1 / \tau + \delta_2) / \gamma}
\end{align}
$$


**R code for the differential equations:**

```{r}
epidemiology <- function(
    S0, I10, I20, I30, D0,
    beta, sigma1, sigma2, delta1, delta2, delta3, gamma, tau, rho, times) {
  
  N <- S0 + I10 + I20 + I30 + D0
  
  ode2(c(S = S0, I1 = I10, I2 = I20, I3 = I30, D = D0),
       times,
       function(time, state, pars) {
         with(as.list(c(state, pars)), {
           foi <- beta * D * S / N
           dS  <- sigma1 * I1 + sigma2 * I2 + gamma * D - foi
           dI1 <- foi - (sigma1 + delta1 + tau) * I1
           dI2 <- tau * I1 - (delta2 + sigma2) * I2
           dI3 <- rho * D - delta3 * I3
           dD  <- delta1 * I1 + delta2 * I2 + delta3 * I3 - (gamma + rho) * D
           list(c(dS, dI1, dI2, dI3, dD))
         })
       },
       c(beta = beta, gamma = gamma, rho = rho,
         sigma1 = sigma1, sigma2 = sigma2,
         delta1 = delta1, delta2 = delta2, delta3 = delta3))
}
```


**R code for the endemic equilibrium:**

```{r}
equilibium <- function(
    beta, sigma1, sigma2, delta1, delta2, delta3, gamma, tau, rho, N) {
  S <- (delta2 + sigma2) * (delta1 + sigma1 + tau) * gamma * N / 
       (((delta2 + sigma2) * delta1 + delta2 * tau) * beta)
  I2 <- (N - S) / 
        ((delta1 * (delta2 + sigma2) / tau + delta2) * (1 + rho / delta3) / gamma + (delta2 + sigma2) / tau + 1)
  c(S = S, I2 = I2)
}
```


**Numerical verification of the equilibrium:**

The calculations:

```{r}
S0  <- 1e6 - 10 # ind
I10 <- 0 # ind
I20 <- 0 # ind
I30 <- 0 # ind
D0  <- 10 # ind

beta   <- 1 # /year/ind
sigma1 <- .1 # /year
sigma2 <- .1 # /year
delta1 <- 1.15 # /year
delta2 <- .1 # /year
delta3 <- .1 # /year
gamma  <- .1 # /year
tau    <- .5 # /year
rho    <- .05 # /year

dynamics <- epidemiology(S0, I10, I20, I30, D0,
                         beta, sigma1, sigma2, delta1, delta2, delta3, gamma, tau, rho,
                         seq2(0, 100))

statics <- equilibium(beta, sigma1, sigma2, delta1, delta2, delta3, gamma, tau, rho,
                      S0 + I10 + I10 + I10 + D0)
```

```{r}
statics
```


The vizualization:

```{r fig.height = 3.5, fig.width  = 1.5 * 4.24725, margin1 = FALSE, margin2 = TRUE}
opar <- par(mfrow = 2:3)
with(dynamics, {
  plot3(time, I1, ylab = "I1")
  plot3(time, I2, ylab = "I2")
  abline(h = statics["I2"], col = 2, lwd = 2)
  plot3(time, I3, ylab = "I3")
  plot3(time, S , ylab = "S")
  abline(h = statics["S"], col = 2, lwd = 2)
  plot3(time, D , ylab = "D")
})
par(opar)
```
