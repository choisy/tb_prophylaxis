---
title: "Model v2.0"
output:
  html_document:
    toc: yes
    toc_float: no
    toc_depth: 4
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo       = TRUE,
                      cache      = TRUE,
                      autodep    = TRUE,
                      message    = FALSE,
                      warning    = FALSE,
                      dev.args   = list(pointsize = 11),
                      fig.height = 3.5,
                      fig.width  = 4.24725,
                      fig.retina = 2,
                      fig.align  = "center")
```

## Packages

Required: `deSolve`, `tibble`

```{r}
library(tibble)
```

## Functions

```{r}
ode2 <- function(...) {
  deSolve::ode(...) |> 
    as.data.frame() |> 
    as_tibble()
}
```

## Epidemiological model

**Variables:**

* $S$: non-infected
* $I_1$: recently infected
* $I_2$: infected a long time ago
* $I_3$: treated but not sterilized
* $D$: sick and infectious
* $N = S + I_1 + I_2 + I_3 + D$

**Parameters:**

* $\beta$: infectious contact rate (/ind/year)
* $\sigma_1$ and $\sigma_2$: clearance rates (/year) of $I_1$ and $I_2$
respectively, either through natural immunity or prophylactic treatment
* $\delta_1$, $\delta_2$ and $\delta_3$: progression rates (/year) of infection
to disease for $I_1$, $I_2$ and $I_3$ (relapse) respectively
* $\gamma$: rate (/year) of recovery with clearance either from treatment or
natural immunity
* $\rho$: rate (/year) of recovery without clearance (ultimately leading to
relapse)

**Note:** all these rates are *per capita*

**Flow diagram:**

<div style="text-align:center"><img src ="SI1I2I3D.png" width="280"/></div>

**Differential equations:**

$$
\begin{align} 
  \frac{dS}{dt}   &= \sigma_1 I_1 + \sigma_2 I_2 + \gamma D - \beta \frac{D}{N} S \\
  \frac{dI_1}{dt} &= \beta \frac{D}{N} S - (\sigma_1 + \delta_1 + \tau) I_1       \\
  \frac{dI_2}{dt} &= \tau I_1 - (\delta_2 + \sigma_2) I_2                         \\
  \frac{dI_3}{dt} &= \rho D - \delta_3 I_3                                        \\
  \frac{dD}{dt}   &= \delta_1 I_1 + \delta_2 I_2 + \delta_3 I_3 - (\gamma + \rho) D
\end{align}
$$
**Endemic equilibrium:**

$$
\begin{align}
  A     &= \frac{(\sigma_2 + \delta_2) \gamma}
                {(\sigma_2 + \delta_2) \delta_1 + \tau \delta_2}     \\
  B     &= 1 + \frac{(\sigma_2 + \delta_2 + \tau) \gamma}
                    {(\sigma_2 + \delta_2) \delta_1 + \tau \delta_2}
             - \frac{\rho}{\delta_3}                                 \\
  D^*   &= \left(1 - \frac{\sigma_1 + \delta_1 + \tau}{\beta}\right)
           \frac{A}{B} N                                             \\
  I_1^* &= AD^*                                                      \\
  I_2^* &= \frac{\tau}{\sigma_2 + \delta_2} I_1^*                    \\
  I_3^* &= \frac{\rho}{\delta_3}D^*                                  \\
  S^*   &= N - I_1^* - I_2^* - I_3^* - D^*
\end{align}
$$

**R code for the differential equations:**

```{r}
epidemiology <- function(
    S0, I10, I20, I30, D0,
    beta, sigma1, sigma2, gamma, delta1, delta2, delta3, rho, times) {
  
  N <- S0 + I10 + I20 + I30 + D0
  
  ode2(c(S = S0, I1 = I10, I2 = I20, I3 = I30, D = D0),
       times,
       function(time, state, pars) {
         with(as.list(c(state, pars)), {
           foi <- beta * D * S / N
           dS  <- sigma1 * I1 + sigma2 * I2 + gamma * D - foi
           dI1 <- foi - (sigma1 + delta1 + tau) * I1
           dI2 <- tau * I1 - (delta2 + sigma2) * I2
           dI3 <- rho * D - delta3 * I3
           dD  <- delta1 * I1 + delta2 * I2 + delta3 * I3 - (gamma + rho) * D
           list(c(dS, dI1, dI2, dI3, dD))
         })},
       c(beta = beta, gamma = gamma, rho = rho,
         sigma1 = sigma1, sigma2 = sigma2,
         delta1 = delta1, delta2 = delta2, delta3 = delta3))
}
```

**R code for the endemic equilibrium:**

```{r}
equilibium <- function(
    beta, sigma1, sigma2, gamma, delta1, delta2, delta3, rho, N) {
  
  A <- (sigma2 + delta2) * gamma / ((sigma2 + delta2) * delta1 + tau * delta2)
  B <- 1 + (sigma2 + delta2 + tau) * gamma /
           ((sigma2 + delta2) * delta1 + tau * delta2) - rho / delta3
  
  Ds <- (1 - (sigma1 + delta1 + tau) / beta) * A * N / B
  I1s <- A * Ds
  I2s <- tau * I1s / (sigma2 + delta2)
  I3s <- rho * Ds / delta3
  
  c(S = N - I1s - I2s - I3s - Ds, I1 = I1s, I2 = I2s, I3 = I3s, D = Ds)
}
```

