---
title: "Optimal proposed duration of a TB prophylactic treatment"
output:
  html_document:
    theme: cerulean
    toc: yes
    toc_float: yes
    toc_depth: 4
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo  = TRUE,
                      cache = TRUE)
```

## 1 Overview

### 1.1 Context and question
The goal is to reduce TB prevalence in the population by proposing a
prophylactic treatment of a given duration to people recently exposed to a
confirmed TB case. The shorter the proposed duration, the lower the efficacy
of the treatment but, also -- we hypothesize --, the higher the uptake rate. The 
question then is whether a higher uptake rate can epidemiologically
(over-)compensate at the population level a lower efficacy of the treatment at
the individual level. If yes, then we are also interested in knowing what is the
proposed duration of the treatment that would lead to the lowest TB prevalence
in the population.

### 1.2 Method

The model contains 2 sub-models. The first one is an epidemiological model of TB
transmission in the population from which we derive a formula of the
prevalence of TB in the population. The second one is a model of prophylactic
treatment policy that accounts for

* contact tracing efficacy;
* treatment uptake as a function of proposed treatment duration;
* the effective treatment duration as a function of the proposed treatment
  duration;
* treatment efficacy as a function of the effective treatment duration.

The distribution of the effective treatment duration as a function of the
proposed treatment duration is itself derived from assumptions made on how
treatment adherence depends on the proposed treatment duration.

The efficacy of the prophylactic treatment policy is then integrated into the
formula of the TB prevalence in order to derive the relationship between the
proposed duration of the prophylactic treatment and the TB prevalance in the
population.

#### 1.2.1 Epidemiological sub-model
We develop a simple 5-parameters epidemiological model of TB that considers 3
clinical status (**Figure 1**): 

* susceptible ($S$);
* infected but neither sick nor infectious ($I$);
* sick and infectious ($D$).

In this model people can transit between $S$ and $I$ and between $I$ and $D$ in
both directions, and from $D$ to $I$. Formulas of the prevalences of $I$ and $D$
at the epidemiological equilibrium are derived. The model is qualibrated by using 
information on

* the prevalence of $I$;
* the prevalence of $D$;
* the proportion of infected that will ultimately develop the disease;
* the proportion of people developing the disease that do so within a given time;
* the proportion of relapse.

#### 1.2.2 Prophylactic treatment sub-model

Here the sub-model aims at computing the efficacy of the prophylactic treatment
policy by accounting for

* contact tracing efficacy;
* treatment uptake;
* treatment adherence that determines the effective treatment duration upon
  uptake;
* treatment efficacy that depends on the effective treatment duration.

**Treatment uptake:** in absence of detailed information of people's behaviour
related to treatment, we phenomenologically model the probability of treatment
uptake as a function of the proposed duration of the proposed prophylactic
treatment. For that, we use a 3-parameter Hill equation that provides a S-curve
with great shape flexibility (**Figure 4**).

**Treatment adherence and effective treatment duration:** any person taking the
treatment can drop it at any time. We thus model the treatment adherence as a
function of the treatment duration in order to compute the effective duration of
treatment that, accounting for drop-outs, will be lower than the proposed
treatment duration. To do so, we consider that any given day in the treatment
the probability of dropping it increases with the number of days since the start
of the treatment (reflecting a *"fatigue"* of taking the treatment) and, at the
same time, decreases with the number of days left in the treatment (reflecting
the fact that *somebody is not likely to give up that close to the "finish line"*). 
(An alternative to this second probability could be to express the time left in
the treatment as a proportion of the total duration of the treatment.) Each of
these 2 effects is modelled by a 3-parameter Hill equation as described above
and, from these two probabilities combined, we derive the probability
distribution of the effective treatment duration among the people taking the
treatment (**Figure 5**). This probability distribution depends on the proposed 
duration of the treatment. From here we can either computer the mean of the
distribution for the rest of the analysis or, instead, propagate this
distribution through the rest of the analysis.

**Treatment efficacy:** the last piece of the puzzle consists in modelling the
treatment efficacy as a function of its effective duration and here again we
make use of a 3-parameter Hill equation to do so (**Figure 6**).

#### 1.2.3 TB prevalence as a function of proposed treatment duration

From the above section we have the efficacy of the prophylactic treatment policy
as a function of its proposed duration. Next step consists in integrating this
efficacy into the formula of the TB prevalence by converting this efficacy into
a rate accounting for the competing risks as defined by the epidemiological
model.Once this is done, we can express the prevalence of TB directly as a
function of the proposed duration of the proposed prophylactic treatment and
then look whether there is a value of the duration of the duration of the
prophylactic treatment that minimizes the TB prevalence (**Figure 7**). As
mentioned above, this can be done by considering either the mean effective
duration of treatment, or the whole distribution of the effective duration of
treatment.

## 2 Packages

The package used in this analysis:

```{r message = FALSE}
library(tibble)
library(deSolve)
library(purrr)
library(dplyr)
```

## 3 Functions

Tuning and defining some utilitary functions.

```{r}
lwd_val <- 2

seq2 <- function(...) seq(..., le = 512)

plot2 <- function(..., col = 4) plot(..., type = "l", lwd = lwd_val, col = col)

lines2 <- function(..., col = 2) lines(..., lwd = lwd_val, col = col)

legend2 <- function(...) legend(..., lty = 1, lwd = lwd_val, bty = "n")

abline2 <- function(...) abline(..., lwd = lwd_val)
```

A few utilitary functions:

```{r}
void_plot <- function() plot(1, type = "n", axes = FALSE, ann = FALSE)
```


## 4 Model

### 4.1 Assumptions

* constant population size
* frequency-dependence transmission
* no mortality
* no immunity against TB

### 4.2 Epidemiological framework

<div style="text-align:center"><img src ="SID.png" width="160"/></div>

**Figure 1:** flow chart of the epidemiological model in which people can be in
3 clinical status: non-infected and susceptible ($S$), infected but neither
sick nor infectious ($I$) and diseased people ($D$).

#### 4.2.1 Parameters


* $N$: population size (ind)
* $\beta$: per capita infectious contact rate (/year/ind)
* $\gamma$: per capita rate of clearance of non-diseased, either naturally or
from whatever treatment policy currently in place (/year)
* $\delta$: per capita rate of clearance of diseased, either naturally or
from whatever treatment policy currently in place (/year)
* $\sigma$: per capita rate of developing disease once infected (/year)
* $q$: proportion of treated diseased that do not clear the bacillus
* $\pi(d)$: per capita rate of clearance of non-diseased, due to prophylactic
treatment (/year). Depends the on duration $d$ of prophylactic treatment (see
below)


#### 4.2.2 Epidemiological dynamics:

$$
\frac{dS}{dt} = (1-q)\delta D + (\gamma + \pi(d)) I - \beta\frac{D}{N}S
$$

$$
\frac{dI}{dt} = \beta\frac{D}{N}S + q\delta D - (\sigma + \gamma + \pi(d)) I
$$

$$
\frac{dD}{dt} = \sigma I - \delta D
$$

#### 4.2.3 Constant population size:

$$
N = S + I + D
$$

#### 4.2.4 Equilibrium 

$$
D^* = \frac{\beta - \left(1 - q + \frac{\gamma + \pi}{\sigma}\right)\delta}
{\left(1 + \frac{\delta}{\sigma}\right)\beta}N
$$


$$
I^* = \frac{\delta}{\sigma}D^*
$$

$$
S^* = N - I^* - D^*
$$


#### 4.2.5 Numerical verification

The model in R:

```{r}
model <- function(S0, I0, D0, beta, sigma, gamma, delta, q, pi, times) {
  N <- S0 + I0 + D0
  ode(
    c(S = S0, I = I0, D = D0),
    times,
    function(time, state, pars) {
      with(as.list(c(state, pars)), {
        infections <- beta * D * S / N
        dS <- (1 - q) * delta * D + (gamma + pi) * I - infections
        dI <- infections + q * delta * D - (sigma + gamma + pi) * I
        dD <- sigma * I - delta * D
        list(c(dS, dI, dD))
      })
    },
    c(beta = beta, sigma = sigma, gamma = gamma, delta = delta, q = q, pi = pi)
  ) |>
    as.data.frame() |> 
    as_tibble()
}
```

The equilibrium values in R:

```{r}
d_star <- function(gamma, sigma, delta, beta, q, pi, N) {
  N * (beta - delta * (1 - q + (gamma + pi) / sigma)) /
    (beta * (1 + delta / sigma))
}

i_star <- function(gamma, sigma, delta, beta, q, pi, N) {
  delta * d_star(gamma, sigma, delta, beta, q, pi, N) / sigma
}

s_star <- function(gamma, sigma, delta, beta, q, pi, N) {
  N - i_star(gamma, sigma, delta, beta, q, pi, N) -
    d_star(gamma, sigma, delta, beta, q, pi, N)
}
```

Let's compare:

```{r fig.width = 7, fig.height = 5 / 2}
S0 <- 1e6 - 10 # ind
I0 <- 0 # ind
D0 <- 10 # ind
beta <- 1 # /year/ind
sigma <- 1.15 # /year
gamma <- .1 # /year
delta <- .1 # /year
q <- .5
pi <- 0 # in absence of prophylaxis

sims <- model(S0, I0, D0, beta, sigma, gamma, delta, q, pi, seq2(0, 50))

plot3 <- function(...) plot2(..., xlab = "time (years)")
abline3 <- function(...) abline2(..., col = 2)
N <- S0 + I0 + D0

opar <- par(mfrow = c(1, 3))
with(sims, plot3(time, S, ylab = "susceptibles S"))
abline3(h = s_star(gamma, sigma, delta, beta, q, pi, N))
with(sims, plot3(time, I, ylab = "infected non-diseased I"))
abline3(h = i_star(gamma, sigma, delta, beta, q, pi, N))
with(sims, plot3(time, D, ylab = "diseased D"))
abline3(h = d_star(gamma, sigma, delta, beta, q, pi, N))
par(opar)
```

**Figure 2:** numerical verification of the formulas for the equilibrium values
of $S$, $I$ and $D$: numerical simulation in blue, values from the formulas in
red.

#### 4.2.6 Estimating / assessing parameters

If $p\%$ of those $I$ who will become $D$ within $E$ years, then the $\sigma$
rate should read

$$
\sigma = -\frac{\log(1 - p)}{E}
$$

If $x$ (typically $3$ to $5\%$) is the proportion of $I$ that will ultimately
move to $D$, then, we have

$$
\frac{\sigma}{\sigma + \gamma} = x
$$

which leads to this expression for $\gamma$:

$$
\gamma = \frac{1 - x}{x}\sigma
$$

We are left with two parameters to estimate ($\beta$ and $\delta$) that we can
estimate from observed values of $I^*$ (between 10 and 40%) and $D^*$ (between
0.15 and 0.30%). First $\delta$:

$$
\delta = \sigma\frac{I^*}{D^*}
$$

And $\beta$:

$$
\beta = \frac{(1 - q)\delta D^* + \gamma I^*}{(N - I^* - D^*)D^*}N
$$
In R:

```{r}
parameters_values <- function(
    p = .9, E = 2, # p% of people developing disease doing so within E years
    x = .04, # proportion of I that will become D (3 to 5%)
    I = .25, # prevalence of I (between 10 and 40%)
    D = 450 / 100000, # prevalence of D (between 150 and 300 / 100,000)
    q = .15 # proportion of "recovered" D that actually go to I instead of S
  ) {
  sigma <- - log(1 - p) / E
  gamma <- sigma * (1 - x) / x
  delta <- sigma * I / D
  beta <- ((1 - q) * delta * D + gamma * I) / ((1 - I - D) * D)
  
  c(beta = beta, gamma = gamma, sigma = sigma, delta = delta)
}
```

```{r}
parameters_values()
```

```{r fig.width = 7, fig.height = 5 / 2}
q <- .15
D0 <- 10 # ind
S0 <- 1e6 - D0 # ind
I0 <- 0 # ind

N <- S0 + I0 + D0
parms <- parameters_values(q = q)
beta  <- parms["beta"] # /year/ind
sigma <- parms["sigma"] # /year
gamma <- parms["gamma"] # /year
delta <- parms["delta"] # /year

sims <- model(S0, I0, D0, beta, sigma, gamma, delta, q, 0, seq2(0, 5))

opar <- par(mfrow = c(1, 3))
with(sims, plot3(time, S, ylab = "susceptibles S"))
abline3(h = s_star(gamma, sigma, delta, beta, q, pi, N))
with(sims, plot3(time, I, ylab = "infected non-diseased I"))
abline3(h = i_star(gamma, sigma, delta, beta, q, pi, N))
with(sims, plot3(time, D, ylab = "diseased D"))
abline3(h = d_star(gamma, sigma, delta, beta, q, pi, N))
par(opar)
```

**Figure 3:** same as Figure 2 but with realistic values of the parameters,
verifying that the prevalences of $I$ and $D$ fit the expected values.

## 5 Prophylaxis

### 5.1 Treatment uptake

We can model the probability of treatment uptake as a function of the treatement
duration using a Hill equation:

$$
\upsilon(d) = \frac{U^u + (1 - \Upsilon)d^u}{U^u + d^u}
$$
In R:

```{r}
uptake <- function(d, Y, U, u) {
  (U^u + (1 - Y) * d^u) / (U^u + d^u)
}
```

Let's visualize it:

```{r fig.width = 7, fig.height = 5 / 2}
ds <- seq2(0, 30)
opar <- par(mfrow = c(1, 3))
void_plot()
plot2(ds, uptake(ds, 1, 15, 4), ylim = 0:1,
      xlab = "duration of treatment (days)", ylab = "uptake probability")
par(opar)
```

**Figure 4:** modelled probability of treatment uptake as a function of proposed
treatment duration.

### 5.2 Treatment adherence and effective duration of treatment

Let's assume that the probability that somebody stops his/her treatment
increases with the number of days s/he's been taking the treatment:

$$
p_1(t) = \theta_1\frac{t^{h_1}}{K_1^{h_1} + t^{h_1}}
$$

But that it also increases with the number days left in the treatment:

$$
p_2(t) = \theta_2\frac{(d - t)^{h_2}}{K_2^{h_2} + (d - t)^{h_2}}
$$
where $d$ is the prescribed duration of treatment. By combining these 2 effects,
we would have something like:

$$
p(t, d) = \theta_1\theta_2\frac{t^{h_1} (d - t)^{h_2}}
                     {(K_1^{h_1} + t^{h_1})(K_2^{h_2} + (d - t)^{h_2})}
$$

in which the second effect could be cancelled by simply setting $\theta_2 = 2$
and $h_2 = 0$. From this we can express the probability that somebody stops his/her treatment **at time $t$** as

$$
P(t,d) = p(t,d)\prod_{x=0}^{{}^{-}t}(1 - p(x,d))^{dx}
$$
The probability distribution of the actual durations of treatment can then be
expressed by:

$$
\varphi(t,d) = \frac{P(t,d)}{\int_{0}^d P(x,d)dx}
$$

In R:

```{r}
p1 <- function(t, theta1, h1, K1) {
  theta1 * t^h1 / (K1^h1 + t^h1)
}

p2 <- function(t, d, theta2, h2, K2) {
  theta2 * (d - t)^h2 / (K2^h2 + (d - t)^h2)
}

durations <- function(d, theta1, theta2, h1, h2, K1, K2, le = 512) {
  xs <- seq(0, d, le = le)
  x <- map_dbl(xs, ~ p1(.x, theta1, h1, K1) * p2(.x, d, theta2, h2, K2))
  out <- c(x[1], x[-1] * cumprod(1 - x[-le]))
  tibble(x = xs,
         y = out / sum(out))
}
```

Let's look at it:

```{r fig.width = 7, fig.height = 5 / 2}
treatment_duration <- 30
theta1 <- .8
h1 <- 3
K1 <- 20
theta2 <- .1
h2 <- 3
K2 <- 20

ts <- seq2(0, 30)

plot4 <- function(...) plot2(..., xlab = "days since the start of treatment")
plot5 <- function(...) plot2(..., xlab = "actual duration of treatment")

opar <- par(mfrow = c(1, 3))
plot4(ds, p1(ts, theta1, h1, K1), ylim = 0:1,
      ylab = "prob 1 of dropping treatment")

plot4(ds, p2(ts, treatment_duration, theta2, h2, K2), ylim = 0:1,
      ylab = "prob 2 of dropping treatment")

with(durations(treatment_duration, theta1, theta2, h1, h2, K1, K2),
     plot5(x, y, ylab = "probability density"))
par(opar)
```

**Figure 5:** the two probabilities of treatment adherence as a function of
duration in the treatment (a) and duration left in the treatment (b) and the
consequence of these probabilities on the distribution of the effective
treatment duration (c).

### 5.3 Treatment efficiency

We can assume that the treatment efficiency as a function of the actual duration
of treatment also follows a Hill equation:

$$
\varepsilon(\varphi) = \xi\frac{\varphi^k}{H^k + \varphi^k}
$$
In R:

```{r}
efficiency <- function(phi, xi, k, H) {
  xi * phi^k / (H^k + phi^k)
}
```

Let's look at it:

```{r fig.width = 7, fig.height = 5 / 2}
opar <- par(mfrow = c(1, 3))
void_plot()
plot5(ts, efficiency(ts, 1, 1, 10), ylim = 0:1, ylab = "treatment efficiency")
par(opar)
```

**Figure 6:** modelled treatment efficacy as a function of the effective
treatment duration.

### 5.4 Prophylaxis

By putting everything together, we can express the probability of successful
prophylactic treatment of infected as

$$
\chi(d) = \tau\xi\frac{\varphi(d)^k}{H^k + \varphi(d)^k} \upsilon(d)
$$
where $\tau$ is the proportion of infected that can be identified through
contact tracing. From this, it comes that the rate $\pi(d)$ can be expressed as

$$
\pi(d) = \frac{\chi(d)}{1 - \chi(d)}(\sigma + \gamma)
$$
This expression of $\pi(d)$ can be fed into the expression of $D*$ to get the
effect of the duration of the proposed prophylactic treatment on the number $D*$
of people with TB:

$$
D^*(d) = \frac{\beta - (1 - q + (\gamma + \pi(d)) / \sigma)\delta}
{(1 + \delta / \sigma)\beta}N
$$
In R:

```{r}
tb_cases <- function(
  tau = .45, # probable range between 30 and 60%
  treatment_duration = 30,
  theta1 = .8,
  h1 = 3,
  K1 = 20,
  theta2 = .1,
  h2 = 3,
  K2 = 20,
  Y = 1,
  U = 15,
  u = 4,
  xi = 1,
  k = 1,
  H = 10,
  p = .9, E = 2, # p% of people developing disease doing so within E years
  x = .04, # proportion of I that will become D (3 to 5%)
  I = .25, # prevalence of I (between 10 and 40%)
  D = 450 / 200000, # prevalence of D (between 150 and 300 / 100,000)
  q = .15, # proportion of "recovered" D that actually goes to I instead of S
  N = 1e5) { # population size

  parms <- parameters_values(p, E, x, I, D, q)
  sigma <- parms["sigma"]
  gamma <- parms["gamma"]
  
  phis <- durations(treatment_duration, theta1, theta2, h1, h2, K1, K2)
  d <- with(phis, sum(x * y))
  chi <- tau * uptake(d, Y, U, u) * efficiency(d, xi, k, H)
  pis <- chi * (sigma + gamma) / (1 - chi)
  
  d_star(gamma, sigma, parms["delta"], parms["beta"], q, pis, N)
}
```


```{r}
xs <- seq2(0, 100)
ys <- map_dbl(xs, ~ tb_cases(treatment_duration = .x))
plot2(xs, ys, xlab = "duration of proposed prophylactic treatment (days)",
      ylab = "TB prevalence (per 100,000)", ylim = c(0, max(ys, na.rm = TRUE)))
```

**Figure 7:** tuberculosis prevalence as a function of proposed duration of
prophylactic treatment.
