---
title: "TB prophylaxis"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Packages

```{r}
library(tibble)
library(deSolve)
```

## Functions

```{r}
lwd_val <- 2
```

```{r}
seq2 <- function(...) seq(..., le = 512)
```

```{r}
plot2 <- function(..., col = 4) plot(..., type = "l", lwd = lwd_val, col = col)
```

```{r}
lines2 <- function(..., col = 2) lines(..., lwd = lwd_val, col = col)
```

```{r}
legend2 <- function(...) legend(..., lty = 1, lwd = lwd_val, bty = "n")
```

```{r}
abline2 <- function(...) abline(..., lwd = lwd_val)
```


## Model

### Assumptions

* constant population size
* frequency-dependence transmission
* no mortality
* no immunity against TB

### Epidemiological framework

<div style="text-align:center"><img src ="SID.png" width="160"/></div>

#### Parameters


* $N$: population size (ind)
* $\beta$: per capita infectious contact rate (/year/ind)
* $\gamma$: per capita rate of clearance of non-diseased, either naturally or
from whatever treatment policy currently in place (/year)
* $\delta$: per capita rate of clearance of diseased, either naturally or
from whatever treatment policy currently in place (/year)
* $\sigma$: per capita rate of developing disease once infected (/year)
* $q$: proportion of treated diseased that do not clear the bacillus
* $\pi(d)$: per capita rate of clearance of non-diseased, due to prophylactic
treatment (/year). Depends the on duration $d$ of prophylactic treatment (see
below)


#### Epidemiological dynamics:

$$
\frac{dS}{dt} = (1-q)\delta D + (\gamma + \pi(d)) I - \beta\frac{D}{N}S
$$

$$
\frac{dI}{dt} = \beta\frac{D}{N}S + q\delta D - (\sigma + \gamma + \pi(d)) I
$$

$$
\frac{dD}{dt} = \sigma I - \delta D
$$

#### Constant population size:

$$
N = S + I + D
$$

#### Equilibrium 

$$
D^* = \frac{\beta - \left(1 - q + \frac{\gamma + \pi}{\sigma}\right)\delta}
{\left(1 + \frac{\delta}{\sigma}\right)\beta}N
$$


$$
I^* = \frac{\delta}{\sigma}D^*
$$

$$
S^* = N - I^* - D^*
$$


#### Numerical verification

The model in R:

```{r}
model <- function(S0, I0, D0, beta, sigma, gamma, delta, q, pi, times) {
  N <- S0 + I0 + D0
  ode(
    c(S = S0, I = I0, D = D0),
    times,
    function(time, state, pars) {
      with(as.list(c(state, pars)), {
        infections <- beta * D * S / N
        dS <- (1 - q) * delta * D + (gamma + pi) * I - infections
        dI <- infections + q * delta * D - (sigma + gamma + pi) * I
        dD <- sigma * I - delta * D
        list(c(dS, dI, dD))
      })
    },
    c(beta = beta, sigma = sigma, gamma = gamma, delta = delta, q = q, pi = pi)
  ) |>
    as.data.frame() |> 
    as_tibble()
}
```

The equilibrium values in R:

```{r}
d_star <- function(gamma, sigma, delta, beta, q, pi, N) {
  N * (beta - delta * (1 - q + (gamma + pi) / sigma)) /
    (beta * (1 + delta / sigma))
}

i_star <- function(gamma, sigma, delta, beta, q, pi, N) {
  delta * d_star(gamma, sigma, delta, beta, q, pi, N) / sigma
}

s_star <- function(gamma, sigma, delta, beta, q, pi, N) {
  N - i_star(gamma, sigma, delta, beta, q, pi, N) -
    d_star(gamma, sigma, delta, beta, q, pi, N)
}
```

Let's compare:

```{r fig.width = 7, fig.height = 5 / 2}
S0 <- 1e6 - 10 # ind
I0 <- 0 # ind
D0 <- 10 # ind
beta <- 1 # /year/ind
sigma <- 1.15 # /year
gamma <- .1 # /year
delta <- .1 # /year
q <- .5
pi <- 0 # in absence of prophylaxis

sims <- model(S0, I0, D0, beta, sigma, gamma, delta, q, pi, seq2(0, 50))

plot3 <- function(...) plot2(..., xlab = "time (years)")
abline3 <- function(...) abline2(..., col = 2)
N <- S0 + I0 + D0

opar <- par(mfrow = c(1, 3))
with(sims, plot3(time, S, ylab = "susceptibles S"))
abline3(h = s_star(gamma, sigma, delta, beta, q, pi, N))
with(sims, plot3(time, I, ylab = "infected non-diseased I"))
abline3(h = i_star(gamma, sigma, delta, beta, q, pi, N))
with(sims, plot3(time, D, ylab = "diseased D"))
abline3(h = d_star(gamma, sigma, delta, beta, q, pi, N))
par(opar)
```

#### Estimating / assessing parameters

If $p\%$ of those $I$ who will become $D$ within $E$ years, then the $\sigma$
rate should read

$$
\sigma = -\frac{\log(1 - p)}{E}
$$

If $x$ (typically $3$ to $5\%$) is the proportion of $I$ that will ultimately
move to $D$, then, we have

$$
\frac{\sigma}{\sigma + \gamma} = x
$$

which leads to this expression for $\gamma$:

$$
\gamma = \frac{1 - x}{x}\sigma
$$

We are left with two parameters to estimate ($\beta$ and $\delta$) that we can
estimate from observed values of $I^*$ (between 10 and 40%) and $D^*$ (between
0.15 and 0.30%). First $\delta$:

$$
\delta = \sigma\frac{I^*}{D^*}
$$

And $\beta$:

$$
\beta = \frac{(1 - q)\delta D^* + \gamma I^*}{(N - I^* - D^*)D^*}N
$$
In R:

```{r}
parameters_values <- function(
    p = .9, E = 2, # p% of people developing disease doing so within E years
    x = .04, # proportion of I that will become D (3 to 5%)
    I = .25, # prevalence of I (between 10 and 40%)
    D = 450 / 100000, # prevalence of D (between 150 and 300 / 100,000)
    q = .15 # proportion of "recovered" D that actually go to I instead of S
  ) {
  sigma <- - log(1 - p) / E
  gamma <- sigma * (1 - x) / x
  delta <- sigma * I / D
  beta <- ((1 - q) * delta * D + gamma * I) / ((1 - I - D) * D)
  
  c(beta = beta, gamma = gamma, sigma = sigma, delta = delta)
}
```

```{r}
parameters_values()
```

```{r fig.width = 7, fig.height = 5 / 2}
q <- .15
D0 <- 10 # ind
S0 <- 1e6 - D0 # ind
I0 <- 0 # ind

N <- S0 + I0 + D0
parms <- parameters_values(q = q)
beta  <- parms["beta"] # /year/ind
sigma <- parms["sigma"] # /year
gamma <- parms["gamma"] # /year
delta <- parms["delta"] # /year

sims <- model(S0, I0, D0, beta, sigma, gamma, delta, q, 0, seq2(0, 5))

opar <- par(mfrow = c(1, 3))
with(sims, plot3(time, S, ylab = "susceptibles S"))
abline3(h = s_star(gamma, sigma, delta, beta, q, pi, N))
with(sims, plot3(time, I, ylab = "infected non-diseased I"))
abline3(h = i_star(gamma, sigma, delta, beta, q, pi, N))
with(sims, plot3(time, D, ylab = "diseased D"))
abline3(h = d_star(gamma, sigma, delta, beta, q, pi, N))
par(opar)
```


## Prophylaxis

Let's assume that the probability that somebody stops his/her treatment
increases with the number of days s/he's been taken the treatment:

$$
p_1(t) = \theta_1\frac{t^{h_1}}{K_1^{h_1} + t^{h_1}}
$$
But that it also increases with the number days left in the treatment:

$$
p_2(t) = \theta_2\frac{(T - t)^{h_2}}{K_2^{h_2} + (T - t)^{h_2}}
$$
where $T$ is the prescribed duration of treatment. By combining this 2 effects,
we would have something like:

$$
p(t, T) = \theta\frac{t^{h_1} (T - t)^{h_2}}
                     {(K_1^{h_1} + t^{h_1})(K_2^{h_2} + (T - t)^{h_2})}
$$
And the probability that somebody stops his/her treatment at time $t$ is

$$
P(t,T) = p(t,T)\prod_{x=0}^{t-1}(1 - p(x,T))
$$
And the probability distribution of the actual duration of treatment would look
like:

$$
d(t,T) = \frac{P(t,T)}{\sum_{t = 0}^TP(t,T)}
$$

In the model, recovery from $I$ thanks to prophylaxis occurs at a rate $\pi(d)$
that depends on the duration $d$ of treatment. This rate can be decomposed as
so:

$$
\pi(d) = \theta\tau(d) \varepsilon(d)
$$
where $\theta$ is the proportion of infections that can be identified through
contact tracing (*e.g.* household or workplace transmission) and thus be
proposed a prophylactic treatment (this parameter may also integrate the
probability that those who are proposed the prophylactic treatment accept it), $\tau(d)$ the probability 

```{r}
tau <- function(d, K, h) {
  K^h / (K^h + d^h)
}
```

```{r}
epsilon <- function(d, L, l) {
  d^l / (L^l + d^l)
}
```


```{r}
ds <- seq2(0, 180) # days
K <- 45 # days
h <- 4
L <- 90 # days
l <- 1

plot2(ds, tau(ds, K, h), xlab = "duration of treatment (days)",
      ylab = "probability")

lines2(ds, epsilon(ds, L, l))

lines2(ds, tau(ds, K, h) * epsilon(ds, L, l), col = 3)

legend2("topright", legend = c("adherence to treatment", "treatment efficiency",
                               "adherence to treatment x treatment efficiency"),
        col = c(4, 2, 3))

abline(h = .5)
```
