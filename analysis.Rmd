---
title: "TB prophylaxis"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Packages

```{r}
library(tibble)
library(deSolve)
```

## Functions

```{r}
lwd_val <- 2
```

```{r}
seq2 <- function(...) seq(..., le = 512)
```

```{r}
plot2 <- function(..., col = 4) plot(..., type = "l", lwd = lwd_val, col = col)
```

```{r}
lines2 <- function(..., col = 2) lines(..., lwd = lwd_val, col = col)
```

```{r}
legend2 <- function(...) legend(..., lty = 1, lwd = lwd_val, bty = "n")
```

```{r}
abline2 <- function(...) abline(..., lwd = lwd_val)
```


## Model

### Assumptions

* constant population size
* frequency-dependence transmission
* no mortality
* no immunity against TB

### Epidemiological framework

<div style="text-align:center"><img src ="SID.png" width="160"/></div>

#### Parameters


* $N$: population size (ind)
* $\beta$: per capita infectious contact rate (/year/ind)
* $\gamma$: per capita rate of clearance of non-diseased, either naturally or
from whatever treatment policy currently in place (/year)
* $\delta$: per capita rate of clearance of diseased, either naturally or
from whatever treatment policy currently in place (/year)
* $\sigma$: per capita rate of developing disease once infected (/year)
* $q$: proportion of treated diseased that do not clear the bacillus
* $\pi(d)$: per capita rate of clearance of non-diseased, due to prophylactic
treatment (/year). Depends the on duration $d$ of prophylactic treatment (see
below)


#### Epidemiological dynamics:

$$
\frac{dS}{dt} = (1-q)\delta D + (\gamma + \pi(d)) I - \beta\frac{D}{N}S
$$

$$
\frac{dI}{dt} = \beta\frac{D}{N}S + q\delta D - (\sigma + \gamma + \pi(d)) I
$$

$$
\frac{dD}{dt} = \sigma I - \delta D
$$

#### Constant population size:

$$
N = S + I + D
$$

#### Equilibrium 

$$
D^* = \frac{\beta - \left(1 - q + \frac{\gamma + \pi}{\sigma}\right)\delta}
{\left(1 + \frac{\delta}{\sigma}\right)\beta}N
$$


$$
I^* = \frac{\delta}{\sigma}D^*
$$

$$
S^* = N - I^* - D^*
$$


#### Numerical verification

The model in R:

```{r}
model <- function(S0, I0, D0, beta, sigma, gamma, delta, q, pi, times) {
  N <- S0 + I0 + D0
  ode(
    c(S = S0, I = I0, D = D0),
    times,
    function(time, state, pars) {
      with(as.list(c(state, pars)), {
        infections <- beta * D * S / N
        dS <- (1 - q) * delta * D + (gamma + pi) * I - infections
        dI <- infections + q * delta * D - (sigma + gamma + pi) * I
        dD <- sigma * I - delta * D
        list(c(dS, dI, dD))
      })
    },
    c(beta = beta, sigma = sigma, gamma = gamma, delta = delta, q = q, pi = pi)
  ) |>
    as.data.frame() |> 
    as_tibble()
}
```

The equilibrium values in R:

```{r}
d_star <- function(gamma, sigma, delta, beta, q, pi, N) {
  N * (beta - delta * (1 - q + (gamma + pi) / sigma)) /
    (beta * (1 + delta / sigma))
}

i_star <- function(gamma, sigma, delta, beta, q, pi, N) {
  delta * d_star(gamma, sigma, delta, beta, q, pi, N) / sigma
}

s_star <- function(gamma, sigma, delta, beta, q, pi, N) {
  N - i_star(gamma, sigma, delta, beta, q, pi, N) -
    d_star(gamma, sigma, delta, beta, q, pi, N)
}
```

Let's compare:

```{r fig.width = 7, fig.height = 5 / 2}
S0 <- 1e6 - 10 # ind
I0 <- 0 # ind
D0 <- 10 # ind
beta <- 1 # /year/ind
sigma <- 1.15 # /year
gamma <- .1 # /year
delta <- .1 # /year
q <- .5
pi <- 0 # in absence of prophylaxis

sims <- model(S0, I0, D0, beta, sigma, gamma, delta, q, pi, seq2(0, 50))

plot3 <- function(...) plot2(..., xlab = "time (years)")
abline3 <- function(...) abline2(..., col = 2)
N <- S0 + I0 + D0

opar <- par(mfrow = c(1, 3))
with(sims, plot3(time, S, ylab = "susceptibles S"))
abline3(h = s_star(gamma, sigma, delta, beta, q, pi, N))
with(sims, plot3(time, I, ylab = "infected non-diseased I"))
abline3(h = i_star(gamma, sigma, delta, beta, q, pi, N))
with(sims, plot3(time, D, ylab = "diseased D"))
abline3(h = d_star(gamma, sigma, delta, beta, q, pi, N))
par(opar)
```

```{r fig.width = 7, fig.height = 5 / 2}
S0 <- 1e6 - 1500 # ind
I0 <- 0 # ind
D0 <- 1500 # ind
beta <- .7 # /year/ind
sigma <- 1.15 # /year
gamma <- .1 # /year
delta <- 1.1 # /year
q <- .5
pi <- 0 # in absence of prophylaxis

sims <- model(S0, I0, D0, beta, sigma, gamma, delta, q, pi, seq2(0, 1000))

plot3 <- function(...) plot2(..., xlab = "time (years)")
abline3 <- function(...) abline2(..., col = 2)
N <- S0 + I0 + D0

opar <- par(mfrow = c(1, 3))
with(sims, plot3(time, S, ylab = "susceptibles S"))
abline3(h = s_star(gamma, sigma, delta, beta, q, pi, N))
with(sims, plot3(time, I, ylab = "infected non-diseased I"))
abline3(h = i_star(gamma, sigma, delta, beta, q, pi, N))
with(sims, plot3(time, D, ylab = "diseased D"))
abline3(h = d_star(gamma, sigma, delta, beta, q, pi, N))
par(opar)
```


#### Estimating / assessing parameters

If $p\%$ of those $I$ who will become $D$ within $E$ years, then the $\sigma$
rate should read

$$
\sigma = -\frac{\log(1 - p)}{E}
$$

```{r}
sigma_rate <- function(E, p) {
  - log(1 - p) / E
}
```

For 90% of infected people developing the disease within 2 years, we then want
$\sigma$ to be equal to:

```{r}
sigma_rate(2, .9) # /year
```

If $g$ (typically $3$ to $5\%$) is the proportion of $I$ that will ultimately
move to $D$, then, we have

$$
\frac{\sigma}{\sigma + \gamma} = g
$$

which leads to this expression for $\gamma$:

$$
\gamma = \frac{1 - g}{g}\sigma
$$
If $j\%$ of those sick and treated leaves the $D$ compartment within $M$ years,
then, the $\delta$ parameter should read:

$$
\delta = -\frac{\log(1 - j)}{M}
$$

We are left with two parameters to estimate ($\beta$ and $q$) that we can
estimate from observed values of $I^*$ (between 10 and 40%) and $D^*$ (between
0.15 and 0.30%). In R, this gives the following function:

```{r}
logit <- function(p) {
  log(p / (1 - p))
}
```

```{r}
ilogit <- function(x) {
  exp(x) / (1 + exp(x))
}
```

```{r}
dpois2 <- function(...) dpois(..., log = TRUE)
```


```{r}
f <- function(
    p = .9, E = 2, # p% of people developing disease doing so within E years
    j = .8, M = 2 / 12, # j% of people recovering within M years
    g = .04, # proportion of I that ultimately move to D
    I = .25, # prevalence of infected (but not diseased) people
    D = .0043, # prevalence of diseased people
    N = 1e6) {
  
  sigma <- - log(1 - p) / E
#  delta <- - log(1 - j) / M
  delta <- sigma * I / D
  gamma <- sigma * (1 - g) / g
  
  I <- round(I * N)
  D <- round(D * N)
 
  x <- c(log(1), logit(.15))
   
  mLL <- function(x) {
    - dpois2(I, i_star(gamma, sigma, delta, exp(x[1]), ilogit(x[2]), 0, N)) -
      dpois2(D, d_star(gamma, sigma, delta, exp(x[1]), ilogit(x[2]), 0, N))
  }
 
#  mLL(c(log(1), logit(.15)))
  
  out <- optim(c(log(1), logit(.15)), mLL)$par
  
  c(sigma = sigma,
    gamma = gamma,
    delta = delta,
    beta  = exp(out[1]),
    q     = ilogit(out[2]))
}

f()
```


## Duration of prophylactic treatment

```{r}
tau <- function(d, K, h) {
  K^h / (K^h + d^h)
}
```

```{r}
epsilon <- function(d, L, l) {
  d^l / (L^l + d^l)
}
```


```{r}
ds <- seq2(0, 180) # days
K <- 45 # days
h <- 4
L <- 90 # days
l <- 1

plot2(ds, tau(ds, K, h), xlab = "duration of treatment (days)",
      ylab = "probability")

lines2(ds, epsilon(ds, L, l))

lines2(ds, tau(ds, K, h) * epsilon(ds, L, l), col = 3)

legend2("topright", legend = c("adherence to treatment", "treatment efficiency",
                               "adherence to treatment x treatment efficiency"),
        col = c(4, 2, 3))

abline(h = .5)
```
